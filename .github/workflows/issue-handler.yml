name: Issue Handler

on:
  issues:
    types: [labeled, unlabeled, closed, reopened]
  issue_comment:
    types: [created]
  # push ì´ë²¤íŠ¸ëŠ” ì›Œí¬í”Œë¡œìš° ê²€ì¦ìš©ìœ¼ë¡œë§Œ ì‚¬ìš© (ì‹¤ì œ ë™ì‘ ì—†ìŒ)
  push:
    paths:
      - '.github/workflows/issue-handler.yml'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

concurrency:
  group: issue-handler
  cancel-in-progress: false

jobs:
  # push ì´ë²¤íŠ¸ì¼ ë•Œ ì›Œí¬í”Œë¡œìš° ê²€ì¦ìš© (ì‹¤ì œ ë™ì‘ ì—†ìŒ)
  validate-workflow:
    if: github.event_name == 'push'
    runs-on: jhl-space
    timeout-minutes: 5
    steps:
      - name: Workflow validation
        run: echo "âœ… issue-handler.yml ì›Œí¬í”Œë¡œìš° ê²€ì¦ ì™„ë£Œ"

  handle-request-label:
    if: github.event.action == 'labeled' && github.event.label.name == 'request'
    runs-on: jhl-space
    timeout-minutes: 15
    outputs:
      has_changes: ${{ steps.commit.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Notify start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ“ ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. AIê°€ ë¬¸ì„œ ì´ˆì•ˆì„ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...'
            })

      - name: Recommend related documents
        id: recommend
        run: |
          echo "ğŸ” ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰ ì¤‘..."
          bun run scripts/document/recommend-documents.js \
            --issue-number "$ISSUE_NUMBER" \
            --issue-title "$ISSUE_TITLE" \
            --issue-body "$ISSUE_BODY"
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Generate document with AI
        id: generate
        run: |
          echo "ğŸ¤– AI ë¬¸ì„œ ìƒì„± ì‹œì‘..."
          bun run scripts/document/generate-document.js \
            --issue-number "$ISSUE_NUMBER" \
            --issue-title "$ISSUE_TITLE" \
            --issue-body "$ISSUE_BODY"
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}

      - name: Build wiki data
        run: |
          bun run build:wiki
          bun run build:search

      - name: Collect workflow status
        run: bun run scripts/collectors/collect-actions-status.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Commit and push
        id: commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "docs: Issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
            git pull --rebase
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0

      - name: Trigger wiki tree maintenance
        if: steps.commit.outputs.has_changes == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: wiki-document-changed

      - name: Add labels
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['draft', 'ai-generated']
            });

      - name: Comment with result
        uses: actions/github-script@v7
        env:
          DOCUMENT_SLUG: ${{ steps.generate.outputs.slug }}
        with:
          script: |
            const slug = process.env.DOCUMENT_SLUG || '';

            const body = [
              'âœ… ë¬¸ì„œ ì´ˆì•ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!',
              '',
              'ğŸ“„ **ë¬¸ì„œ ìœ„ì¹˜**: `wiki/' + slug + '.md`',
              'ğŸ”— **ë¯¸ë¦¬ë³´ê¸°**: [ë¬¸ì„œ ë³´ê¸°](https://' + context.repo.owner + '.github.io/' + context.repo.repo + '/wiki/' + slug + ')',
              '',
              '> â³ **ì°¸ê³ **: ë°°í¬ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ë§í¬ê°€ í™œì„±í™”ë˜ê¸°ê¹Œì§€ 1~2ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
              '',
              '---',
              '',
              'ì´ ë¬¸ì„œëŠ” AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í•œ ì´ˆì•ˆì…ë‹ˆë‹¤.',
              '- ê²€í† ê°€ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ëŒ“ê¸€ë¡œ í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.',
              '- ë¬¸ì„œê°€ ì™„ì„±ë˜ë©´ ì´ Issueë¥¼ ë‹«ì•„ì£¼ì„¸ìš”.'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  handle-invalid-label:
    if: github.event.action == 'labeled' && github.event.label.name == 'invalid'
    runs-on: jhl-space
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Notify start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ ì˜¤ë¥˜ê°€ ë³´ê³ ë˜ì—ˆìŠµë‹ˆë‹¤. AIê°€ ë¬¸ì„œë¥¼ ê²€í† í•˜ê³  ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤...'
            })

      - name: Process invalid label with AI
        id: process
        run: |
          echo "ğŸ¤– Invalid ì²˜ë¦¬ ì‹œì‘..."
          bun run scripts/issue/mark-invalid.js \
            --issue-number "$ISSUE_NUMBER" \
            --issue-title "$ISSUE_TITLE" \
            --issue-body "$ISSUE_BODY"
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Build wiki data
        run: |
          bun run build:wiki
          bun run build:search

      - name: Collect workflow status
        run: bun run scripts/collectors/collect-actions-status.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Commit and push
        id: commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "fix: Issue #${{ github.event.issue.number }} - ì˜¤ë¥˜ ìˆ˜ì •"
            git pull --rebase
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0

      - name: Comment with result
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… ë¬¸ì„œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í†  í›„ ë¬¸ì œê°€ í•´ê²°ë˜ì—ˆë‹¤ë©´ invalid ë¼ë²¨ì„ ì œê±°í•´ì£¼ì„¸ìš”.'
            });

  handle-issue-close:
    if: github.event.action == 'closed'
    runs-on: jhl-space
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Notify start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ“¤ Issueê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¬¸ì„œë¥¼ ë°œí–‰ ìƒíƒœë¡œ ì „í™˜ ì¤‘ì…ë‹ˆë‹¤...'
            })

      - name: Publish document
        id: publish
        run: |
          echo "ğŸ“¤ ë¬¸ì„œ ë°œí–‰ ì‹œì‘..."
          bun run scripts/document/publish-document.js \
            --issue-number "$ISSUE_NUMBER" \
            --issue-title "$ISSUE_TITLE"
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Build wiki data
        run: |
          bun run build:wiki
          bun run build:search

      - name: Collect workflow status
        run: bun run scripts/collectors/collect-actions-status.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Commit and push
        id: commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "docs: Issue #${{ github.event.issue.number }} - ë¬¸ì„œ ë°œí–‰"
            git pull --rebase
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0

      - name: Remove draft label
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'draft'
              });
            } catch (e) {
              console.log('draft ë¼ë²¨ì´ ì—†ê±°ë‚˜ ì œê±° ì‹¤íŒ¨:', e.message);
            }

      - name: Add published label
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['published']
            });

      - name: Comment with result
        uses: actions/github-script@v7
        env:
          DOCUMENT_SLUG: ${{ steps.publish.outputs.slug }}
        with:
          script: |
            const slug = process.env.DOCUMENT_SLUG || '';

            const body = [
              'âœ… ë¬¸ì„œê°€ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!',
              '',
              'ğŸ”— **ë°œí–‰ëœ ë¬¸ì„œ**: [ë¬¸ì„œ ë³´ê¸°](https://' + context.repo.owner + '.github.io/' + context.repo.repo + '/wiki/' + slug + ')',
              '',
              '> â³ **ì°¸ê³ **: ë°°í¬ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ë³€ê²½ ì‚¬í•­ì´ ë°˜ì˜ë˜ê¸°ê¹Œì§€ 1~2ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
              '',
              '---',
              '',
              'ì´ ë¬¸ì„œëŠ” ì´ì œ ì •ì‹ ë°œí–‰ ìƒíƒœì…ë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‰'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  handle-issue-reopen:
    if: github.event.action == 'reopened'
    runs-on: jhl-space
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Notify start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ”„ Issueê°€ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤. ë¬¸ì„œë¥¼ ì´ˆì•ˆ ìƒíƒœë¡œ ì „í™˜ ì¤‘ì…ë‹ˆë‹¤...'
            })

      - name: Unpublish document
        id: unpublish
        run: |
          echo "ğŸ“¥ ë¬¸ì„œ ë°œí–‰ ì·¨ì†Œ ì‹œì‘..."
          bun run scripts/document/unpublish-document.js \
            --issue-number "$ISSUE_NUMBER" \
            --issue-title "$ISSUE_TITLE"
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Build wiki data
        run: |
          bun run build:wiki
          bun run build:search

      - name: Collect workflow status
        run: bun run scripts/collectors/collect-actions-status.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Commit and push
        id: commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "docs: Issue #${{ github.event.issue.number }} - ë¬¸ì„œ ë°œí–‰ ì·¨ì†Œ"
            git pull --rebase
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0

      - name: Remove published label
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'published'
              });
            } catch (e) {
              console.log('published ë¼ë²¨ì´ ì—†ê±°ë‚˜ ì œê±° ì‹¤íŒ¨:', e.message);
            }

      - name: Add draft label
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['draft']
            });

      - name: Comment with result
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              'ğŸ“ ë¬¸ì„œê°€ ì´ˆì•ˆ ìƒíƒœë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.',
              '',
              '- `published` ë¼ë²¨ì´ ì œê±°ë˜ê³  `draft` ë¼ë²¨ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
              '- ë¬¸ì„œ ìˆ˜ì •ì´ í•„ìš”í•˜ë©´ ëŒ“ê¸€ë¡œ í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.',
              '- ìˆ˜ì •ì´ ì™„ë£Œë˜ë©´ Issueë¥¼ ë‹¤ì‹œ ë‹«ì•„ì£¼ì„¸ìš”.'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  handle-maintainer-comment:
    if: github.event_name == 'issue_comment'
    runs-on: jhl-space
    timeout-minutes: 15
    steps:
      - name: Check if maintainer or owner
        id: check-maintainer
        uses: actions/github-script@v7
        with:
          script: |
            const commentUser = context.payload.comment.user.login;
            console.log(`ëŒ“ê¸€ ì‘ì„±ì: ${commentUser}`);

            try {
              // ì‚¬ìš©ìì˜ repo ê¶Œí•œ ë ˆë²¨ ì§ì ‘ í™•ì¸
              const { data: permissionData } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: commentUser,
              });

              const permission = permissionData.permission;
              console.log(`${commentUser}ì˜ ê¶Œí•œ ë ˆë²¨: ${permission}`);

              // admin, maintain, write ê¶Œí•œì´ë©´ true
              const hasPermission = ['admin', 'maintain', 'write'].includes(permission);
              console.log(`maintainer ê¶Œí•œ ì—¬ë¶€: ${hasPermission}`);
              return hasPermission;
            } catch (error) {
              console.log(`ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: ${error.message}`);
              return false;
            }

      - name: Checkout
        if: steps.check-maintainer.outputs.result == 'true'
        uses: actions/checkout@v4

      - name: Setup Bun
        if: steps.check-maintainer.outputs.result == 'true'
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.check-maintainer.outputs.result == 'true'
        run: bun install

      - name: Notify start
        if: steps.check-maintainer.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ”„ í”¼ë“œë°±ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. AIê°€ ë¬¸ì„œë¥¼ ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤...'
            })

      - name: Process maintainer feedback with AI
        if: steps.check-maintainer.outputs.result == 'true'
        id: process
        run: |
          echo "ğŸ¤– í”¼ë“œë°± ì²˜ë¦¬ ì‹œì‘..."
          bun run scripts/document/process-feedback.js \
            --issue-number "$ISSUE_NUMBER" \
            --issue-title "$ISSUE_TITLE" \
            --comment-body "$COMMENT_BODY"
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Build wiki data
        if: steps.check-maintainer.outputs.result == 'true'
        run: |
          bun run build:wiki
          bun run build:search

      - name: Collect workflow status
        if: steps.check-maintainer.outputs.result == 'true'
        run: bun run scripts/collectors/collect-actions-status.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Commit and push
        if: steps.check-maintainer.outputs.result == 'true'
        id: commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "docs: Issue #${{ github.event.issue.number }} - í”¼ë“œë°± ë°˜ì˜"
            git pull --rebase
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0

      - name: Trigger wiki tree maintenance
        if: steps.check-maintainer.outputs.result == 'true' && steps.commit.outputs.has_changes == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: wiki-document-changed

      - name: Comment with result
        if: steps.check-maintainer.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… í”¼ë“œë°±ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë³€ê²½ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'
            })

  handle-question-label:
    if: github.event.action == 'labeled' && github.event.label.name == 'question'
    runs-on: jhl-space
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Notify start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¤” ì§ˆë¬¸ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. AIê°€ Wiki ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...'
            })

      - name: Answer question with AI
        id: answer
        run: |
          echo "ğŸ¤– AI ì§ˆë¬¸ ì‘ë‹µ ì‹œì‘..."
          bun run scripts/document/answer-question.js \
            --issue-number "$ISSUE_NUMBER" \
            --issue-title "$ISSUE_TITLE" \
            --issue-body "$ISSUE_BODY"
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}

      - name: Commit AI history
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
          else
            git commit -m "docs: Issue #${{ github.event.issue.number }} - AI ì§ˆë¬¸ ì‘ë‹µ"
            git pull --rebase
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0

  handle-update-request-label:
    if: github.event.action == 'labeled' && github.event.label.name == 'update-request'
    runs-on: jhl-space
    timeout-minutes: 15
    outputs:
      has_changes: ${{ steps.commit.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Notify start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ“ ìˆ˜ì • ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. AIê°€ ë¬¸ì„œë¥¼ ë¶„ì„í•˜ê³  ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤...'
            })

      - name: Update document with AI
        id: update
        run: |
          echo "ğŸ¤– ë¬¸ì„œ ìˆ˜ì • ì‹œì‘..."
          bun run scripts/document/update-document.js \
            --issue-number "$ISSUE_NUMBER" \
            --issue-title "$ISSUE_TITLE" \
            --issue-body "$ISSUE_BODY"
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}

      - name: Build wiki data
        run: |
          bun run build:wiki
          bun run build:search

      - name: Commit and push
        id: commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "docs: Issue #${{ github.event.issue.number }} - ë¬¸ì„œ ìˆ˜ì • ìš”ì²­ ì²˜ë¦¬"
            git pull --rebase
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0

  # ëª¨ë“  handle jobì´ ì™„ë£Œëœ í›„ ë°°í¬ (í•˜ë‚˜ë¼ë„ ì„±ê³µí•˜ë©´ ì‹¤í–‰)
  deploy:
    needs: [handle-request-label, handle-invalid-label, handle-issue-close, handle-issue-reopen, handle-maintainer-comment, handle-question-label, handle-update-request-label]
    if: |
      always() &&
      !cancelled() &&
      (
        needs.handle-request-label.result == 'success' ||
        needs.handle-invalid-label.result == 'success' ||
        needs.handle-issue-close.result == 'success' ||
        needs.handle-issue-reopen.result == 'success' ||
        needs.handle-maintainer-comment.result == 'success' ||
        needs.handle-question-label.result == 'success' ||
        needs.handle-update-request-label.result == 'success'
      )
    runs-on: jhl-space
    timeout-minutes: 5
    steps:
      - name: Trigger deploy workflow
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸš€ ë°°í¬ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-pages.yml',
              ref: 'main'
            });
            console.log('âœ… ë°°í¬ ì›Œí¬í”Œë¡œìš°ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
