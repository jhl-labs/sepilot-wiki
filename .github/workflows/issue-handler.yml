name: Issue Handler

on:
  issues:
    types: [labeled, unlabeled, closed, reopened]
  issue_comment:
    types: [created]
  push:
    paths:
      - '.github/workflows/issue-handler.yml'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

concurrency:
  group: issue-handler-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  validate-workflow:
    if: github.event_name == 'push'
    runs-on: jhl-space
    timeout-minutes: 5
    steps:
      - name: Workflow validation
        run: echo "âœ… issue-handler.yml ì›Œí¬í”Œë¡œìš° ê²€ì¦ ì™„ë£Œ"

  handle-request-label:
    if: github.event.action == 'labeled' && github.event.label.name == 'request'
    uses: ./.github/workflows/reusable-document-handler.yml
    with:
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
      issue_body: ${{ github.event.issue.body }}
      start_message: 'ğŸ“ ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. AIê°€ ë¬¸ì„œ ì´ˆì•ˆì„ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...'
      script_command: |
        echo "ğŸ” ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰ ì¤‘..."
        bun run scripts/document/recommend-documents.js \
          --issue-number "$ISSUE_NUMBER" \
          --issue-title "$ISSUE_TITLE" \
          --issue-body "$ISSUE_BODY"
        echo "ğŸ¤– AI ë¬¸ì„œ ìƒì„± ì‹œì‘..."
        bun run scripts/document/generate-document.js \
          --issue-number "$ISSUE_NUMBER" \
          --issue-title "$ISSUE_TITLE" \
          --issue-body "$ISSUE_BODY"
      commit_message: "docs: Issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
      labels_to_add: 'draft,ai-generated'
      trigger_tree_maintenance: true
      success_message: 'âœ… ë¬¸ì„œ ì´ˆì•ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!'
    secrets:
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}

  handle-invalid-label:
    if: github.event.action == 'labeled' && github.event.label.name == 'invalid'
    uses: ./.github/workflows/reusable-document-handler.yml
    with:
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
      issue_body: ${{ github.event.issue.body }}
      start_message: 'âš ï¸ ì˜¤ë¥˜ê°€ ë³´ê³ ë˜ì—ˆìŠµë‹ˆë‹¤. AIê°€ ë¬¸ì„œë¥¼ ê²€í† í•˜ê³  ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤...'
      script_command: |
        echo "ğŸ¤– Invalid ì²˜ë¦¬ ì‹œì‘..."
        bun run scripts/issue/mark-invalid.js \
          --issue-number "$ISSUE_NUMBER" \
          --issue-title "$ISSUE_TITLE" \
          --issue-body "$ISSUE_BODY"
      commit_message: "fix: Issue #${{ github.event.issue.number }} - ì˜¤ë¥˜ ìˆ˜ì •"
      success_message: 'âœ… ë¬¸ì„œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í†  í›„ ë¬¸ì œê°€ í•´ê²°ë˜ì—ˆë‹¤ë©´ invalid ë¼ë²¨ì„ ì œê±°í•´ì£¼ì„¸ìš”.'
    secrets:
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}

  handle-issue-close:
    if: >
      github.event.action == 'closed' &&
      !contains(toJSON(github.event.issue.labels.*.name), 'wiki-maintenance')
    uses: ./.github/workflows/reusable-document-handler.yml
    with:
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
      start_message: 'ğŸ“¤ Issueê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¬¸ì„œë¥¼ ë°œí–‰ ìƒíƒœë¡œ ì „í™˜ ì¤‘ì…ë‹ˆë‹¤...'
      script_command: |
        echo "ğŸ“¤ ë¬¸ì„œ ë°œí–‰ ì‹œì‘..."
        bun run scripts/document/publish-document.js \
          --issue-number "$ISSUE_NUMBER" \
          --issue-title "$ISSUE_TITLE"
      commit_message: "docs: Issue #${{ github.event.issue.number }} - ë¬¸ì„œ ë°œí–‰"
      labels_to_add: 'published'
      labels_to_remove: 'draft'
      success_message: 'âœ… ë¬¸ì„œê°€ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰'
    secrets: {}

  handle-issue-reopen:
    if: >
      github.event.action == 'reopened' &&
      !contains(toJSON(github.event.issue.labels.*.name), 'wiki-maintenance')
    uses: ./.github/workflows/reusable-document-handler.yml
    with:
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
      start_message: 'ğŸ”„ Issueê°€ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤. ë¬¸ì„œë¥¼ ì´ˆì•ˆ ìƒíƒœë¡œ ì „í™˜ ì¤‘ì…ë‹ˆë‹¤...'
      script_command: |
        echo "ğŸ“¥ ë¬¸ì„œ ë°œí–‰ ì·¨ì†Œ ì‹œì‘..."
        bun run scripts/document/unpublish-document.js \
          --issue-number "$ISSUE_NUMBER" \
          --issue-title "$ISSUE_TITLE"
      commit_message: "docs: Issue #${{ github.event.issue.number }} - ë¬¸ì„œ ë°œí–‰ ì·¨ì†Œ"
      labels_to_add: 'draft'
      labels_to_remove: 'published'
      success_message: 'ğŸ“ ë¬¸ì„œê°€ ì´ˆì•ˆ ìƒíƒœë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.'
    secrets: {}

  handle-maintainer-comment:
    if: >
      github.event_name == 'issue_comment' &&
      !contains(toJSON(github.event.issue.labels.*.name), 'wiki-maintenance')
    runs-on: jhl-space
    timeout-minutes: 15
    steps:
      - name: Check if maintainer or owner
        id: check-maintainer
        uses: actions/github-script@v7
        with:
          script: |
            const commentUser = context.payload.comment.user.login;
            console.log(`ëŒ“ê¸€ ì‘ì„±ì: ${commentUser}`);

            try {
              const { data: permissionData } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: commentUser,
              });

              const permission = permissionData.permission;
              console.log(`${commentUser}ì˜ ê¶Œí•œ ë ˆë²¨: ${permission}`);

              const hasPermission = ['admin', 'maintain', 'write'].includes(permission);
              console.log(`maintainer ê¶Œí•œ ì—¬ë¶€: ${hasPermission}`);
              return hasPermission;
            } catch (error) {
              console.log(`ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: ${error.message}`);
              return false;
            }

      - name: Skip if not maintainer
        if: steps.check-maintainer.outputs.result != 'true'
        run: echo "ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì, ê±´ë„ˆëœ€"

  handle-maintainer-comment-action:
    needs: handle-maintainer-comment
    if: >
      github.event_name == 'issue_comment' &&
      !contains(toJSON(github.event.issue.labels.*.name), 'wiki-maintenance') &&
      needs.handle-maintainer-comment.result == 'success'
    uses: ./.github/workflows/reusable-document-handler.yml
    with:
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
      comment_body: ${{ github.event.comment.body }}
      start_message: 'ğŸ”„ í”¼ë“œë°±ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. AIê°€ ë¬¸ì„œë¥¼ ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤...'
      script_command: |
        echo "ğŸ¤– í”¼ë“œë°± ì²˜ë¦¬ ì‹œì‘..."
        bun run scripts/document/process-feedback.js \
          --issue-number "$ISSUE_NUMBER" \
          --issue-title "$ISSUE_TITLE" \
          --comment-body "$COMMENT_BODY"
      commit_message: "docs: Issue #${{ github.event.issue.number }} - í”¼ë“œë°± ë°˜ì˜"
      trigger_tree_maintenance: true
      success_message: 'âœ… í”¼ë“œë°±ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë³€ê²½ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'
    secrets:
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}

  handle-question-label:
    if: github.event.action == 'labeled' && github.event.label.name == 'question'
    uses: ./.github/workflows/reusable-document-handler.yml
    with:
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
      issue_body: ${{ github.event.issue.body }}
      start_message: 'ğŸ¤” ì§ˆë¬¸ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. AIê°€ Wiki ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...'
      script_command: |
        echo "ğŸ¤– AI ì§ˆë¬¸ ì‘ë‹µ ì‹œì‘..."
        bun run scripts/document/answer-question.js \
          --issue-number "$ISSUE_NUMBER" \
          --issue-title "$ISSUE_TITLE" \
          --issue-body "$ISSUE_BODY"
      commit_message: "docs: Issue #${{ github.event.issue.number }} - AI ì§ˆë¬¸ ì‘ë‹µ"
      build_wiki: false
      collect_actions: false
    secrets:
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}

  handle-update-request-label:
    if: github.event.action == 'labeled' && github.event.label.name == 'update-request'
    uses: ./.github/workflows/reusable-document-handler.yml
    with:
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
      issue_body: ${{ github.event.issue.body }}
      start_message: 'ğŸ“ ìˆ˜ì • ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. AIê°€ ë¬¸ì„œë¥¼ ë¶„ì„í•˜ê³  ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤...'
      script_command: |
        echo "ğŸ¤– ë¬¸ì„œ ìˆ˜ì • ì‹œì‘..."
        bun run scripts/document/update-document.js \
          --issue-number "$ISSUE_NUMBER" \
          --issue-title "$ISSUE_TITLE" \
          --issue-body "$ISSUE_BODY"
      commit_message: "docs: Issue #${{ github.event.issue.number }} - ë¬¸ì„œ ìˆ˜ì • ìš”ì²­ ì²˜ë¦¬"
      collect_actions: false
    secrets:
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}

  deploy:
    needs: [handle-request-label, handle-invalid-label, handle-issue-close, handle-issue-reopen, handle-maintainer-comment-action, handle-question-label, handle-update-request-label]
    if: |
      always() &&
      !cancelled() &&
      (
        needs.handle-request-label.result == 'success' ||
        needs.handle-invalid-label.result == 'success' ||
        needs.handle-issue-close.result == 'success' ||
        needs.handle-issue-reopen.result == 'success' ||
        needs.handle-maintainer-comment-action.result == 'success' ||
        needs.handle-question-label.result == 'success' ||
        needs.handle-update-request-label.result == 'success'
      )
    runs-on: jhl-space
    timeout-minutes: 5
    steps:
      - name: Trigger deploy workflow
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸš€ ë°°í¬ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-pages.yml',
              ref: 'main'
            });
            console.log('âœ… ë°°í¬ ì›Œí¬í”Œë¡œìš°ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
