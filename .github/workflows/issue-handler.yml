name: Issue Handler

on:
  issues:
    types: [labeled, unlabeled, closed]
  issue_comment:
    types: [created]
  # push ì´ë²¤íŠ¸ëŠ” ì›Œí¬í”Œë¡œìš° ê²€ì¦ìš©ìœ¼ë¡œë§Œ ì‚¬ìš© (ì‹¤ì œ ë™ì‘ ì—†ìŒ)
  push:
    paths:
      - '.github/workflows/issue-handler.yml'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  # push ì´ë²¤íŠ¸ì¼ ë•Œ ì›Œí¬í”Œë¡œìš° ê²€ì¦ìš© (ì‹¤ì œ ë™ì‘ ì—†ìŒ)
  validate-workflow:
    if: github.event_name == 'push'
    runs-on: jhl-space
    steps:
      - name: Workflow validation
        run: echo "âœ… issue-handler.yml ì›Œí¬í”Œë¡œìš° ê²€ì¦ ì™„ë£Œ"

  handle-request-label:
    if: github.event.action == 'labeled' && github.event.label.name == 'request'
    runs-on: jhl-space
    outputs:
      has_changes: ${{ steps.commit.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Notify start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ“ ìš”ì²­ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. AIê°€ ë¬¸ì„œ ì´ˆì•ˆì„ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...'
            })

      - name: Generate document with AI
        id: generate
        run: |
          echo "ğŸ¤– AI ë¬¸ì„œ ìƒì„± ì‹œì‘..."
          bun run scripts/generate-document.js \
            --issue-number "${{ github.event.issue.number }}" \
            --issue-title "${{ github.event.issue.title }}" \
            --issue-body "${{ github.event.issue.body }}"
        env:
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}

      - name: Build wiki data
        run: |
          bun run build:wiki
          bun run build:search

      - name: Commit and push
        id: commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "docs: Issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add labels
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['draft', 'ai-generated']
            });

      - name: Comment with result
        uses: actions/github-script@v7
        with:
          script: |
            const issueTitle = context.payload.issue.title;
            const slug = issueTitle
              .toLowerCase()
              .replace(/[^a-z0-9ê°€-í£\s-]/g, '')
              .replace(/\s+/g, '-')
              .replace(/-+/g, '-')
              .trim()
              .slice(0, 50);

            const body = [
              'âœ… ë¬¸ì„œ ì´ˆì•ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!',
              '',
              'ğŸ“„ **ë¬¸ì„œ ìœ„ì¹˜**: `wiki/' + slug + '.md`',
              'ğŸ”— **ë¯¸ë¦¬ë³´ê¸°**: [ë¬¸ì„œ ë³´ê¸°](https://' + context.repo.owner + '.github.io/' + context.repo.repo + '/wiki/' + slug + ')',
              '',
              '> â³ **ì°¸ê³ **: ë°°í¬ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ë§í¬ê°€ í™œì„±í™”ë˜ê¸°ê¹Œì§€ 1~2ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
              '',
              '---',
              '',
              'ì´ ë¬¸ì„œëŠ” AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í•œ ì´ˆì•ˆì…ë‹ˆë‹¤.',
              '- ê²€í† ê°€ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ëŒ“ê¸€ë¡œ í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.',
              '- ë¬¸ì„œê°€ ì™„ì„±ë˜ë©´ ì´ Issueë¥¼ ë‹«ì•„ì£¼ì„¸ìš”.'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  handle-invalid-label:
    if: github.event.action == 'labeled' && github.event.label.name == 'invalid'
    runs-on: jhl-space
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mark document as invalid
        run: |
          echo "Issue #${{ github.event.issue.number }} - Invalid ë¼ë²¨ ê°ì§€"
          # ë¬¸ì„œì— ê²½ê³  í‘œì‹œ ì¶”ê°€ ë¡œì§
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ ì´ ë¬¸ì„œì— ì˜¤ë¥˜ê°€ ë³´ê³ ë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í†  í›„ ìˆ˜ì •í•˜ê² ìŠµë‹ˆë‹¤.'
            });

  handle-issue-close:
    if: github.event.action == 'closed'
    runs-on: jhl-space
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Finalize document
        run: |
          echo "Issue #${{ github.event.issue.number }} - ì¢…ë£Œë¨"
          # draft ë¼ë²¨ ì œê±°, ì •ì‹ ë¬¸ì„œë¡œ ì „í™˜
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove draft label
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'draft'
              });
            } catch (e) {
              console.log('draft ë¼ë²¨ì´ ì—†ê±°ë‚˜ ì œê±° ì‹¤íŒ¨:', e.message);
            }

  handle-maintainer-comment:
    if: github.event_name == 'issue_comment'
    runs-on: jhl-space
    steps:
      - name: Check if maintainer or owner
        id: check-maintainer
        uses: actions/github-script@v7
        with:
          script: |
            const commentUser = context.payload.comment.user.login;

            // repo owner í™•ì¸
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            if (repo.owner.login === commentUser) {
              console.log(`${commentUser}ì€(ëŠ”) repo ownerì…ë‹ˆë‹¤.`);
              return true;
            }

            // collaborator ê¶Œí•œ í™•ì¸
            const { data: collaborators } = await github.rest.repos.listCollaborators({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const isMaintainer = collaborators.some(
              c => c.login === commentUser &&
                   (c.permissions.admin || c.permissions.maintain)
            );

            console.log(`${commentUser} maintainer ê¶Œí•œ: ${isMaintainer}`);
            return isMaintainer;

      - name: Checkout
        if: steps.check-maintainer.outputs.result == 'true'
        uses: actions/checkout@v4

      - name: Setup Bun
        if: steps.check-maintainer.outputs.result == 'true'
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.check-maintainer.outputs.result == 'true'
        run: bun install

      - name: Process maintainer feedback
        if: steps.check-maintainer.outputs.result == 'true'
        run: |
          echo "Maintainer í”¼ë“œë°± ì²˜ë¦¬"
          echo "ëŒ“ê¸€ ì‘ì„±ì: ${{ github.event.comment.user.login }}"
          echo "ëŒ“ê¸€ ë‚´ìš©: ${{ github.event.comment.body }}"
          # AIë¥¼ í†µí•œ í”¼ë“œë°± ë°˜ì˜ ë¡œì§ (ì¶”í›„ êµ¬í˜„)
        env:
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_TOKEN: ${{ secrets.OPENAI_TOKEN }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}

  # ëª¨ë“  handle jobì´ ì™„ë£Œëœ í›„ ë°°í¬ (handle-request-labelì—ì„œ ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰)
  deploy:
    needs: [handle-request-label, handle-invalid-label, handle-issue-close, handle-maintainer-comment]
    if: |
      always() &&
      !cancelled() &&
      (needs.handle-request-label.result == 'success' && needs.handle-request-label.outputs.has_changes == 'true')
    runs-on: jhl-space
    steps:
      - name: Trigger deploy workflow
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸš€ ë°°í¬ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-pages.yml',
              ref: 'main'
            });
            console.log('âœ… ë°°í¬ ì›Œí¬í”Œë¡œìš°ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
