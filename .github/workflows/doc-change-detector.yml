name: Document Change Detector

# ë¹„í™œì„±í™”: ë‹¨ìˆœ í…ìŠ¤íŠ¸ ë§¤ì¹­ìœ¼ë¡œ ì¸í•œ ê±°ì§“ ì–‘ì„±(false positive) ë‹¤ìˆ˜ ë°œìƒ
# ë§¤ì¹­ ë¡œì§ ê°œì„  í›„ ìž¬í™œì„±í™” í•„ìš” (source_files frontmatter ê¸°ë°˜ ë“±)
# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'src/**'
#       - 'lib/**'
#       - 'app/**'
#       - 'scripts/**'
on:
  workflow_dispatch:

concurrency:
  group: doc-change-detector
  cancel-in-progress: true

jobs:
  detect-updates:
    runs-on: jhl-space
    timeout-minutes: 15
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Get changed files
        id: changes
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD | tr '\n' ',')
          echo "files=$CHANGED" >> $GITHUB_OUTPUT

      - name: Detect document updates needed
        id: detect
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: bun scripts/maintenance/detect-doc-updates.js --changed-files "${{ steps.changes.outputs.files }}"

      - name: Job summary
        run: |
          echo "## ðŸ” ì½”ë“œ ë³€ê²½ â†’ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ê°ì§€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê²°ê³¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ì—…ë°ì´íŠ¸ í•„ìš” | ${{ steps.detect.outputs.has_updates || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì˜í–¥ë°›ëŠ” ë¬¸ì„œ | ${{ steps.detect.outputs.affected_docs || '0' }}ê°œ |" >> $GITHUB_STEP_SUMMARY
          echo "| ìƒì„±ëœ Issue | ${{ steps.detect.outputs.issues_created || '0' }}ê°œ |" >> $GITHUB_STEP_SUMMARY
