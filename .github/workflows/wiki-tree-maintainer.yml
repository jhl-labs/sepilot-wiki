name: Wiki Tree Maintainer

on:
  # ì£¼ 1íšŒ ì‹¤í–‰ (ë§¤ì£¼ ì›”ìš”ì¼ UTC 0ì‹œ = KST 9ì‹œ)
  schedule:
    - cron: '0 0 * * 1'

  # ë¬¸ì„œ ìƒì„±/ìˆ˜ì • í›„ ìžë™ íŠ¸ë¦¬ê±°
  repository_dispatch:
    types: [wiki-document-changed]

  # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ë³€ê²½ ì ìš© ì•ˆí•¨)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      force_run:
        description: 'ë³€ê²½ ì—†ì–´ë„ ê°•ì œ ì‹¤í–‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

concurrency:
  group: wiki-tree-maintainer
  cancel-in-progress: false

jobs:
  maintain-wiki-tree:
    runs-on: jhl-space
    timeout-minutes: 15
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun and Install
        uses: ./.github/actions/setup-bun-install

      - name: Run Wiki Tree Maintainer
        id: maintain
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: bun scripts/maintenance/maintain-wiki-tree.js

      - name: Track error on maintainer failure
        if: steps.maintain.outcome == 'failure'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          bun run scripts/lib/error-tracker.js \
            --workflow "wiki-tree-maintainer" \
            --step "maintain_wiki_tree" \
            --message "Wiki Tree Maintainer ì‹¤íŒ¨" \
            --run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Normalize tags
        id: tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: bun scripts/maintenance/normalize-tags.js

      - name: Build wiki data
        if: steps.maintain.outputs.has_changes == 'true' || steps.tags.outputs.has_changes == 'true'
        uses: ./.github/actions/build-wiki

      - name: Commit and push changes
        if: steps.maintain.outputs.has_changes == 'true' || steps.tags.outputs.has_changes == 'true'
        uses: ./.github/actions/git-commit-push
        with:
          message: "ðŸŒ³ Wiki Tree Maintenance: ${{ steps.maintain.outputs.summary }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger deploy
        if: steps.maintain.outputs.has_changes == 'true' || steps.tags.outputs.has_changes == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: wiki-tree-updated

      - name: Job summary
        run: |
          echo "## ðŸŒ³ Wiki Tree Maintainer ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê²°ê³¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ë³€ê²½ ì‚¬í•­ | ${{ steps.maintain.outputs.has_changes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ìžë™ ì ìš© | ${{ steps.maintain.outputs.applied_count || '0' }}ê°œ |" >> $GITHUB_STEP_SUMMARY
          echo "| ë³´ë¥˜ | ${{ steps.maintain.outputs.skipped_count || '0' }}ê°œ |" >> $GITHUB_STEP_SUMMARY
          echo "| Issue ìƒì„± | ${{ steps.maintain.outputs.issues_created || '0' }}ê°œ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.maintain.outputs.summary || 'Wiki êµ¬ì¡° ë¶„ì„ ì™„ë£Œ' }}" >> $GITHUB_STEP_SUMMARY
